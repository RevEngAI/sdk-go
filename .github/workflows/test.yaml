name: Test

on:
  pull_request:

jobs:
  test:
    runs-on: ubuntu-latest

    permissions:
      contents: read

    steps:
    - name: Checkout repository
      uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

    - name: Find SDK module directory
      id: find-module
      run: |
        MODULE_DIR=$(find . -maxdepth 1 -type d -regex './v[0-9]+' | sort -V | tail -n 1)
        if [ -z "$MODULE_DIR" ]; then
          echo "No vX directory found" >&2
          exit 1
        fi
        echo "module_dir=$MODULE_DIR" >> "$GITHUB_OUTPUT"
        GO_VERSION=$(grep -oP '^go \K[0-9]+\.[0-9]+' "$MODULE_DIR/go.mod")
        echo "go_version=${GO_VERSION}.x" >> "$GITHUB_OUTPUT"

    - name: Setup Go
      uses: actions/setup-go@7a3fe6cf4cb3a834922a1244abfce67bcef6a0c5 # v6.2.0
      with:
        go-version: ${{ steps.find-module.outputs.go_version }}

    - name: Run tests
      working-directory: ${{ steps.find-module.outputs.module_dir }}
      run: go test -v ./...
